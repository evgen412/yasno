<!DOCTYPE html>

<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>–û—Ç–∫–ª—é—á–µ–Ω–∏—è —Å–≤–µ—Ç–∞ ‚Äî YASNO</title>
  <style>
    :root {
      --bg: #000000;
      --card: #1c1c1e;
      --primary: #0a84ff;
      --ok: #30d158;
      --warn: #ff453a;
      --muted: #8e8e93;
      --border: #2c2c2e;
    }

```
body.light {
  --bg: #f2f2f7;
  --card: #ffffff;
  --primary: #0a84ff;
  --ok: #34c759;
  --warn: #ff3b30;
  --muted: #6c6c70;
  --border: #d1d1d6;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', system-ui, Roboto, sans-serif;
  background: var(--bg);
  color: #f2f2f7;
  padding: 16px;
  max-width: 720px;
  margin: 0 auto;
  font-size: 17px;
}

body.light { color: #1c1c1e; }

h1 { font-size: 1.5rem; margin: 6px 0 14px; }

.controls { margin-bottom: 14px; }
select, button {
  padding: 12px 16px;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: var(--card);
  color: inherit;
  font-size: 1rem;
}

button { cursor: pointer; }

.card {
  background: var(--card);
  border-radius: 16px;
  padding: 14px 16px;
  margin-bottom: 12px;
}

.status { font-size: 1.15rem; font-weight: 600; }
.status.on { color: var(--ok); }
.status.off { color: var(--warn); }

.sub { margin-top: 6px; color: var(--muted); }
.sub.warn { color: var(--warn); font-weight: 600; }

.day-title { font-weight: 600; margin-bottom: 8px; }

.slots { display: grid; gap: 6px; }
.slot {
  padding: 10px 14px;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: var(--card);
}
.slot.current {
  border-left: 4px solid var(--warn);
  background: rgba(255,69,58,0.18);
  font-weight: 600;
}
.slot.next {
  border-left: 4px solid var(--primary);
  background: rgba(10,132,255,0.15);
}

.error { color: var(--warn); font-weight: 600; }
```

  </style>
</head>
<body>
  <h1 id="title">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</h1>

  <div class="controls">
    –ì–æ—Ä–æ–¥: <select id="city"></select>
    –ì—Ä—É–ø–ø–∞: <select id="group"></select>
    <button id="theme">üåô</button>
  </div>

  <div id="out">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>

<script>
// ‚ö†Ô∏è corsproxy.io —á–∞—Å—Ç–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç GitHub Pages
// –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –ø—É–±–ª–∏—á–Ω—ã–π –ø—Ä–æ–∫—Å–∏
// allorigins —Ç—Ä–µ–±—É–µ—Ç URLENCODED url
// Cloudflare Worker
const API = 'https://yasno-proxy.uzgen140.workers.dev';
const DEF_CITY = 'kiev';
const DEF_GROUP = 'group_2.2';

const store = (k,v)=>{ try{localStorage.setItem(k,v)}catch{} };
const load = k=>{ try{return localStorage.getItem(k)}catch{return null} };

const citySel = document.getElementById('city');
const groupSel = document.getElementById('group');
const out = document.getElementById('out');
const title = document.getElementById('title');
const themeBtn = document.getElementById('theme');

function kyivNow(){
  return new Date(new Date().toLocaleString('en-US',{timeZone:'Europe/Kyiv'}));
}

function hoursToDate(v, base){
  const h = Math.floor(v);
  const m = Math.round((v - h) * 60);
  const d = new Date(base);
  d.setHours(h, m, 0, 0);
  return d;
}

function fmt(v){
  const h = String(Math.floor(v)).padStart(2,'0');
  const m = v % 1 ? '30' : '00';
  return `${h}:${m}`;
}

(async function init(){
  try{
    const res = await fetch(API);
    if (!res.ok) throw new Error('network');
    const text = await res.text();
    const json = JSON.parse(text);
    const comp = json.components?.find(c=>c.template_name==='electricity-outages-daily-schedule');
    if(!comp || !comp.schedule) throw new Error('schedule not found');
    const daily = comp.schedule;

    let city = load('city') || DEF_CITY;
    let group = load('group') || DEF_GROUP;

    Object.keys(daily).forEach(c=>{
      const o=document.createElement('option');
      o.value=c; o.textContent=c;
      if(c===city) o.selected=true;
      citySel.appendChild(o);
    });

    function render(){
      const now = kyivNow();
      const cityData = daily[city];
      if(!cityData) return;

      groupSel.innerHTML='';
      Object.keys(cityData).forEach(g=>{
        const o=document.createElement('option');
        o.value=g; o.textContent=g.replace('group_','');
        if(g===group) o.selected=true;
        groupSel.appendChild(o);
      });

      const gData = cityData[group];
      title.textContent = city+' ‚Äî –≥—Ä—É–ø–ø–∞ '+group.replace('group_','');

      const slots = gData[0] || [];
      const outages = slots.filter(s=>s.type==='POSSIBLE_OUTAGE');

      let current=null, next=null;
      outages.forEach(s=>{
        const f = hoursToDate(s.start, now);
        const t = hoursToDate(s.end, now);
        if(now>=f && now<=t) current=s;
        if(f>now && !next) next=s;
      });

      out.innerHTML='';
      const card=document.createElement('div'); card.className='card';
      const st=document.createElement('div');
      st.className='status '+(current?'off':'on');
      st.textContent=current?'‚ö° –û—Ç–∫–ª—é—á–µ–Ω–∏–µ —Å–µ–π—á–∞—Å':'üí° –°–≤–µ—Ç –µ—Å—Ç—å';
      card.appendChild(st);

      const sub=document.createElement('div'); sub.className='sub';
      if(current){
        const m=Math.floor((parseTime(current.end,now)-now)/60000);
        sub.textContent='–î–æ –≤–∫–ª—é—á–µ–Ω–∏—è: '+m+' –º–∏–Ω';
      } else if(next){
        const m=Math.floor((parseTime(next.start,now)-now)/60000);
        sub.classList.add('warn');
        sub.textContent='–î–æ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è: '+m+' –º–∏–Ω';
      } else sub.textContent='–û—Ç–∫–ª—é—á–µ–Ω–∏–π –±–æ–ª—å—à–µ –Ω–µ—Ç';
      card.appendChild(sub);
      out.appendChild(card);

      const dayCard=document.createElement('div'); dayCard.className='card';
      const dt=document.createElement('div'); dt.className='day-title'; dt.textContent='–°–µ–≥–æ–¥–Ω—è';
      dayCard.appendChild(dt);
      const list=document.createElement('div'); list.className='slots';
      slots.forEach(s=>{
        const d=document.createElement('div'); d.className='slot';
        d.textContent = `${fmt(s.start)} ‚Äî ${fmt(s.end)}`;
        if(current===s) d.classList.add('current');
        if(next===s) d.classList.add('next');
        list.appendChild(d);
      });
      dayCard.appendChild(list);
      out.appendChild(dayCard);
    }

    render();
    citySel.onchange=()=>{city=citySel.value; store('city',city); render();};
    groupSel.onchange=()=>{group=groupSel.value; store('group',group); render();};
    setInterval(render,5*60*1000);
  }catch(e){ out.innerHTML='<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div>'; }
})();

const savedTheme = load('theme');
if(savedTheme==='light') document.body.classList.add('light');

themeBtn.onclick=()=>{
  document.body.classList.toggle('light');
  store('theme',document.body.classList.contains('light')?'light':'dark');
};
</script>

</body>
</html>
