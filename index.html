<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì—Ä–∞—Ñ–∏–∫ –æ—Ç–∫–ª—é—á–µ–Ω–∏–π</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí°</text></svg>">
    <style>
        :root {
            --bg: #000000;
            --card: #1c1c1e;
            --primary: #0a84ff;
            --ok: #30d158;
            --warn: #ff453a;
            --muted: #8e8e93;
            --border: #38383a;
            --debug-bg: #111;
        }

        body.light {
            --bg: #f2f2f7;
            --card: #ffffff;
            --primary: #0a84ff;
            --ok: #34c759;
            --warn: #ff3b30;
            --muted: #6c6c70;
            --border: #d1d1d6;
            --debug-bg: #fff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', system-ui, Roboto, sans-serif;
            background: var(--bg);
            color: #f2f2f7;
            padding: 16px;
            max-width: 720px;
            margin: 0 auto;
            font-size: 17px;
        }

        body.light { color: #1c1c1e; }

        h1 { font-size: 1.5rem; margin: 6px 0 14px; }

        .controls { margin-bottom: 14px; }
        select, button {
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--card);
            color: inherit;
            font-size: 1rem;
            -webkit-appearance: none;
        }

        button { cursor: pointer; }

        .card {
            background: var(--card);
            border-radius: 16px;
            padding: 14px 16px;
            margin-bottom: 12px;
        }

        .status { font-size: 1.15rem; font-weight: 600; }
        .status.on { color: var(--ok); }
        .status.off { color: var(--warn); }
        .status.unknown { color: var(--muted); }

        .sub { margin-top: 6px; color: var(--muted); }
        .sub.warn { color: var(--warn); font-weight: 600; }
        
        /* –°—Ç–∏–ª—å —Ç–∞–π–º–µ—Ä–∞ */
        .timer-container {
            text-align: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }
        .timer-label {
            font-size: 0.9rem;
            color: var(--muted);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }
        .timer-value {
            font-size: 2.5rem;
            line-height: 1;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
        }
        .timer-red { color: var(--warn); }
        .timer-green { color: var(--ok); }

        .day-title { font-weight: 600; margin-bottom: 8px; margin-top: 12px;}

        .slots { display: grid; gap: 6px; }
        .slot {
            padding: 10px 14px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--card);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .slot.type-electricity { border-left: 4px solid var(--ok); background: rgba(48, 209, 88, 0.1); }
        .slot.type-possible { border-left: 4px solid var(--muted); background: rgba(142,142,147, 0.1); }
        .slot.type-definite { border-left: 4px solid var(--warn); background: rgba(255,69,58,0.15); }
        .slot.is-now { border: 2px solid var(--primary); font-weight: 600; }

        .schedule-type {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            margin-bottom: 8px;
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
        }
        .type-actual { color: var(--warn); background: rgba(255,69,58,0.1); }
        .type-planned { color: var(--primary); background: rgba(10,132,255,0.1); }

        /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –¥–Ω–µ–π */
        .day-switcher {
            display: flex;
            background: rgba(118, 118, 128, 0.12);
            padding: 2px;
            border-radius: 9px;
            margin-bottom: 12px;
        }
        .day-btn {
            flex: 1;
            border: none;
            background: transparent;
            padding: 6px 0;
            font-size: 0.9rem;
            font-weight: 500;
            color: inherit;
            border-radius: 7px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .day-btn.active {
            background: var(--card);
            box-shadow: 0 3px 8px rgba(0,0,0,0.12);
            font-weight: 600;
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .hidden { display: none; }
        
        #debugConsole {
            display: none; 
            margin-top: 30px;
            padding: 10px;
            background: var(--debug-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-family: monospace;
            font-size: 11px;
            color: var(--muted);
            white-space: pre-wrap;
            max-height: 150px;
            overflow-y: auto;
            word-break: break-all;
        }
        .log-error { color: var(--warn); }
        .log-success { color: var(--ok); }
        .log-data { color: var(--primary); }
    </style>
</head>
<body>

    <div class="header-row">
        <h1>–ì—Ä–∞—Ñ–∏–∫ –û—Ç–∫–ª—é—á–µ–Ω–∏–π</h1>
        <div class="controls" style="margin:0;">
            <button id="themeToggle">–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞</button>
        </div>
    </div>

    <div class="controls" style="display: flex; gap: 10px; flex-wrap: wrap;">
        <select id="citySelect" style="flex: 1;">
            <option value="" disabled selected>–ó–∞–≥—Ä—É–∑–∫–∞ –≥–æ—Ä–æ–¥–æ–≤...</option>
        </select>
        
        <select id="groupSelect" style="flex: 1;" disabled>
            <option value="" disabled selected>–ì–æ—Ä–æ–¥ –Ω–µ –≤—ã–±—Ä–∞–Ω</option>
        </select>
    </div>

    <div id="content" class="hidden">
        <div class="card" id="statusCard">
            <div class="status on" id="statusTitle">–°—Ç–∞—Ç—É—Å –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω</div>
            <div class="sub" id="statusSub">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
            
            <div class="timer-container hidden" id="timerContainer">
                <div id="timerLabel" class="timer-label">...</div>
                <div id="timerValue" class="timer-value">--:--</div>
            </div>
        </div>

        <div class="card">
            <div id="scheduleTypeBadge" class="schedule-type type-planned">–ü–ª–∞–Ω–æ–≤—ã–π –≥—Ä–∞—Ñ–∏–∫</div>
            
            <div class="day-switcher">
                <button class="day-btn active" id="btnToday">–°–µ–≥–æ–¥–Ω—è</button>
                <button class="day-btn" id="btnTomorrow">–ó–∞–≤—Ç—Ä–∞</button>
            </div>

            <div class="day-title" id="scheduleDate">–°–µ–≥–æ–¥–Ω—è</div>
            <div class="slots" id="slotsContainer"></div>
        </div>
    </div>

    <div id="placeholder" class="card" style="text-align: center; color: var(--muted);">
        –í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –∏ –≥—Ä—É–ø–ø—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –≥—Ä–∞—Ñ–∏–∫
    </div>

    <div id="debugConsole">–õ–æ–≥ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:</div>

    <script>
        const btn = document.getElementById('themeToggle');
        
        if (localStorage.getItem('theme') === 'light') {
            document.body.classList.add('light');
            btn.textContent = '–¢–µ–º–Ω–∞—è —Ç–µ–º–∞';
        }

        btn.addEventListener('click', () => {
            document.body.classList.toggle('light');
            const isLight = document.body.classList.contains('light');
            btn.textContent = isLight ? '–¢–µ–º–Ω–∞—è —Ç–µ–º–∞' : '–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞';
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
        });

        const API_BASE = 'https://yasno-proxy.uzgen140.workers.dev'; 
        const DEFAULT_CITY = 'kiev';
        const DEFAULT_GROUP = 'group_2.2';

        let GLOBAL_DATA = {
            schedule: {},
            isActual: {} 
        };
        
        let SELECTED_DAY_OFFSET = 0;

        const CityNames = {
            'kiev': '–ö–∏–µ–≤',
            'dnipro': '–î–Ω–µ–ø—Ä',
            'odesa': '–û–¥–µ—Å—Å–∞',
            'lviv': '–õ—å–≤–æ–≤'
        };

        function log(msg, type = 'info') {
            const consoleDiv = document.getElementById('debugConsole');
            const line = document.createElement('div');
            line.textContent = `> ${msg}`;
            if (type === 'error') line.className = 'log-error';
            if (type === 'success') line.className = 'log-success';
            if (type === 'data') line.className = 'log-data';
            consoleDiv.appendChild(line);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
            console.log(msg);
        }

        function findDeepKey(obj, keyToFind) {
            if (!obj || typeof obj !== 'object') return null;
            if (obj[keyToFind]) return obj[keyToFind];
            if (Array.isArray(obj)) {
                for (let item of obj) {
                    const found = findDeepKey(item, keyToFind);
                    if (found) return found;
                }
                return null;
            }
            for (let k of Object.keys(obj)) {
                if (typeof obj[k] === 'object' && obj[k] !== null) {
                    const found = findDeepKey(obj[k], keyToFind);
                    if (found) return found;
                }
            }
            return null;
        }

        function findCityData(container, cityName) {
            if (!container) return null;
            if (container[cityName]) return container[cityName];
            const key = Object.keys(container).find(k => 
                k.toLowerCase() === cityName.toLowerCase() || 
                k.toLowerCase().includes(`-${cityName}`) ||
                k.toLowerCase().includes(`${cityName}-`)
            );
            if (key) return container[key];
            return null;
        }

        async function loadCities() {
            log(`–ó–∞–≥—Ä—É–∑–∫–∞ –≥–æ—Ä–æ–¥–æ–≤...`);
            try {
                const res = await fetch(`${API_BASE}/cities`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                if (data.page && data.page.available_regions) return data.page.available_regions;
                const schedule = findDeepKey(data, 'schedule');
                if (schedule) return Object.keys(schedule);
                return [];
            } catch (e) {
                log(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–æ—Ä–æ–¥–æ–≤: ${e.message}`, 'error');
                return [];
            }
        }

        async function fetchScheduleForCity(city) {
            log(`–ó–∞–≥—Ä—É–∂–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ –¥–ª—è: ${city}...`);
            const url = `${API_BASE}/groups?city=${city}`;
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();

                const dailySchedule = findDeepKey(data, 'dailySchedule');
                if (dailySchedule) {
                    const cityData = findCityData(dailySchedule, city);
                    if (cityData) {
                        if (cityData.groups) {
                            GLOBAL_DATA.schedule[city] = cityData.groups;
                            GLOBAL_DATA.isActual[city] = true;
                            log(`–ù–∞—à–µ–ª —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –≥—Ä–∞—Ñ–∏–∫!`, 'success');
                            return true;
                        } 
                        else if (Object.keys(cityData).some(k => k.startsWith('group'))) {
                            GLOBAL_DATA.schedule[city] = cityData;
                            GLOBAL_DATA.isActual[city] = true;
                            log(`–ù–∞—à–µ–ª —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –≥—Ä–∞—Ñ–∏–∫!`, 'success');
                            return true;
                        }
                    }
                }

                const schedule = findDeepKey(data, 'schedule');
                if (schedule) {
                    const cityData = findCityData(schedule, city);
                    if (cityData) {
                        GLOBAL_DATA.schedule[city] = cityData;
                        GLOBAL_DATA.isActual[city] = false;
                        log(`–ó–∞–≥—Ä—É–∂–µ–Ω –ø–ª–∞–Ω–æ–≤—ã–π –≥—Ä–∞—Ñ–∏–∫`, 'success');
                        return true;
                    }
                }
                log(`–ì—Ä–∞—Ñ–∏–∫ –¥–ª—è –≥–æ—Ä–æ–¥–∞ ${city} –Ω–µ –Ω–∞–π–¥–µ–Ω`, 'error');
                return false;
            } catch (e) {
                log(`–û—à–∏–±–∫–∞: ${e.message}`, 'error');
                return false;
            }
        }

        const citySelect = document.getElementById('citySelect');
        const groupSelect = document.getElementById('groupSelect');
        const contentDiv = document.getElementById('content');
        const placeholderDiv = document.getElementById('placeholder');
        const slotsContainer = document.getElementById('slotsContainer');
        const badge = document.getElementById('scheduleTypeBadge');
        
        const timerContainer = document.getElementById('timerContainer');
        const timerLabel = document.getElementById('timerLabel');
        const timerValue = document.getElementById('timerValue');

        const btnToday = document.getElementById('btnToday');
        const btnTomorrow = document.getElementById('btnTomorrow');

        async function init() {
            const cities = await loadCities();
            citySelect.innerHTML = '<option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option>';
            if (cities && cities.length > 0) {
                cities.forEach(region => {
                    const opt = document.createElement('option');
                    opt.value = region;
                    opt.textContent = CityNames[region] || region.toUpperCase();
                    citySelect.appendChild(opt);
                });

                let targetCity = localStorage.getItem('selectedCity');
                const savedGroup = localStorage.getItem('selectedGroup');
                
                if (!targetCity && cities.includes(DEFAULT_CITY)) targetCity = DEFAULT_CITY;

                if (targetCity && cities.includes(targetCity)) {
                    citySelect.value = targetCity;
                    await onCityChange(false);
                    
                    let targetGroup = null;
                    if (savedGroup) {
                        const hasSaved = Array.from(groupSelect.options).some(opt => opt.value === savedGroup);
                        if (hasSaved) targetGroup = savedGroup;
                    }
                    if (!targetGroup && targetCity === DEFAULT_CITY) {
                        const hasDefault = Array.from(groupSelect.options).some(opt => opt.value === DEFAULT_GROUP);
                        if (hasDefault) targetGroup = DEFAULT_GROUP;
                    }

                    if (targetGroup) {
                        groupSelect.value = targetGroup;
                        onGroupChange(); 
                    }
                }
            } else {
                citySelect.innerHTML = '<option disabled>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
            }

            // –ó–ê–ü–£–°–ö –û–ë–ù–û–í–õ–ï–ù–ò–Ø –¢–ê–ô–ú–ï–†–ê
            // 1. –ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
            setInterval(() => {
                if (citySelect.value && groupSelect.value) {
                    onGroupChange(); // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
                }
            }, 60000);

            // 2. –ü—Ä–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É (–º–≥–Ω–æ–≤–µ–Ω–Ω–æ)
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden && citySelect.value && groupSelect.value) {
                    onGroupChange();
                }
            });
        }

        async function onCityChange(resetGroup = true) {
            const city = citySelect.value;
            groupSelect.innerHTML = '<option value="" disabled selected>–ó–∞–≥—Ä—É–∑–∫–∞...</option>';
            groupSelect.disabled = true;
            contentDiv.classList.add('hidden');
            placeholderDiv.classList.remove('hidden');
            
            if (resetGroup) localStorage.removeItem('selectedGroup');

            if (!GLOBAL_DATA.schedule[city]) {
                const loaded = await fetchScheduleForCity(city);
                if (!loaded) {
                    groupSelect.innerHTML = '<option disabled>–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö</option>';
                    return;
                }
            }
            populateGroups(city);
        }

        function onGroupChange() {
            const city = citySelect.value;
            const group = groupSelect.value;
            if (!city || !group) return;
            
            const scheduleObj = GLOBAL_DATA.schedule[city];
            if (!scheduleObj || !scheduleObj[group]) {
                log(`–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä—É–ø–ø—ã ${group}`, 'error');
                return;
            }
            
            const rawSchedule = scheduleObj[group];
            const isActual = GLOBAL_DATA.isActual[city];
            renderSchedule(rawSchedule, isActual);
            contentDiv.classList.remove('hidden');
            placeholderDiv.classList.add('hidden');
        }

        btnToday.addEventListener('click', () => {
            if (SELECTED_DAY_OFFSET !== 0) {
                SELECTED_DAY_OFFSET = 0;
                btnToday.classList.add('active');
                btnTomorrow.classList.remove('active');
                onGroupChange(); 
            }
        });

        btnTomorrow.addEventListener('click', () => {
            if (SELECTED_DAY_OFFSET !== 1) {
                SELECTED_DAY_OFFSET = 1;
                btnTomorrow.classList.add('active');
                btnToday.classList.remove('active');
                onGroupChange(); 
            }
        });

        citySelect.addEventListener('change', () => {
            localStorage.setItem('selectedCity', citySelect.value);
            onCityChange(true);
        });

        groupSelect.addEventListener('change', () => {
            localStorage.setItem('selectedGroup', groupSelect.value);
            onGroupChange();
        });

        function populateGroups(city) {
            const scheduleObj = GLOBAL_DATA.schedule[city];
            if (!scheduleObj) return;
            const groupKeys = Object.keys(scheduleObj).sort();
            const validGroups = groupKeys.filter(k => k.includes('group'));

            if (validGroups.length === 0) {
                groupSelect.innerHTML = '<option disabled>–ù–µ—Ç –≥—Ä—É–ø–ø</option>';
                return;
            }
            groupSelect.innerHTML = '<option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É</option>';
            validGroups.forEach(key => {
                const opt = document.createElement('option');
                opt.value = key;
                const cleanName = key.replace('group_', '').replace('.', '.');
                opt.textContent = `–ì—Ä—É–ø–ø–∞ ${cleanName}`;
                groupSelect.appendChild(opt);
            });
            groupSelect.disabled = false;
        }

        function normalizeSchedule(rawSlots) {
            if (!rawSlots || !Array.isArray(rawSlots)) return [];
            
            const sorted = [...rawSlots].sort((a, b) => a.start - b.start);
            const fullDay = [];
            let currentTime = 0;

            for (const slot of sorted) {
                const start = parseFloat(slot.start);
                const end = parseFloat(slot.end);

                if (start > currentTime) {
                    fullDay.push({
                        start: currentTime,
                        end: start,
                        type: 'ELECTRICITY'
                    });
                }
                
                fullDay.push({
                    start: start,
                    end: end,
                    type: slot.type
                });
                
                currentTime = end;
            }

            if (currentTime < 24) {
                fullDay.push({
                    start: currentTime,
                    end: 24,
                    type: 'ELECTRICITY'
                });
            }

            return fullDay;
        }

        function renderSchedule(rawSchedule, isActual) {
            const today = new Date();
            const viewDate = new Date(today);
            viewDate.setDate(today.getDate() + SELECTED_DAY_OFFSET);
            
            const options = { weekday: 'long', day: 'numeric', month: 'long' };
            document.getElementById('scheduleDate').textContent = viewDate.toLocaleDateString('ru-RU', options);
            slotsContainer.innerHTML = '';

            if (isActual) {
                badge.textContent = "–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –≥—Ä–∞—Ñ–∏–∫ (–¢–æ—á–Ω—ã–π)";
                badge.className = "schedule-type type-actual";
            } else {
                badge.textContent = "–ü–ª–∞–Ω–æ–≤—ã–π –≥—Ä–∞—Ñ–∏–∫ (–í–æ–∑–º–æ–∂–Ω—ã–π)";
                badge.className = "schedule-type type-planned";
            }

            if (!rawSchedule || !Array.isArray(rawSchedule) || rawSchedule.length === 0) {
                slotsContainer.innerHTML = '<div class="sub">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
                updateStatusHeader(null);
                timerContainer.classList.add('hidden');
                return;
            }

            let todayRaw = [];
            let tomorrowRaw = [];
            let viewRaw = [];

            if (isActual || rawSchedule.length <= 3) {
                todayRaw = rawSchedule[0] || [];
                tomorrowRaw = rawSchedule[1] || [];
                viewRaw = SELECTED_DAY_OFFSET === 0 ? todayRaw : tomorrowRaw;
            } else {
                const jsDay = today.getDay(); 
                const todayIndex = (jsDay === 0) ? 6 : jsDay - 1;
                const nextIndex = (todayIndex + 1) % 7;
                
                todayRaw = rawSchedule[todayIndex] || [];
                tomorrowRaw = rawSchedule[nextIndex] || [];
                
                const viewIndex = (todayIndex + SELECTED_DAY_OFFSET) % 7;
                viewRaw = rawSchedule[viewIndex] || [];
            }

            const viewSchedule = normalizeSchedule(viewRaw);
            const currentHour = today.getHours() + today.getMinutes() / 60;

            if (viewSchedule.length === 0) {
                slotsContainer.innerHTML = '<div class="sub">–ù–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç</div>';
            } else {
                dayScheduleRender(viewSchedule, currentHour);
            }

            const todayNorm = normalizeSchedule(todayRaw);
            const tomorrowNorm = normalizeSchedule(tomorrowRaw);
            
            if (todayNorm.length > 0) {
                updateStatusHeader(todayNorm, currentHour);
                updateCountdown(todayNorm, tomorrowNorm, currentHour);
            } else {
                updateStatusHeader(null);
                timerContainer.classList.add('hidden');
            }
        }

        function dayScheduleRender(schedule, currentHour) {
            schedule.forEach(slot => {
                const div = document.createElement('div');
                let className = 'slot';
                let typeText = '';
                
                if (slot.type === 'DEFINITE_OUTAGE') {
                    className += ' type-definite';
                    typeText = '–û—Ç–∫–ª—é—á–µ–Ω–∏–µ (–§–∞–∫—Ç)';
                } else if (slot.type === 'POSSIBLE_OUTAGE') {
                    className += ' type-possible';
                    typeText = '–í–æ–∑–º–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ';
                } else {
                    className += ' type-electricity';
                    typeText = '–°–≤–µ—Ç –µ—Å—Ç—å';
                }

                if (SELECTED_DAY_OFFSET === 0 && currentHour >= slot.start && currentHour < slot.end) {
                    className += ' is-now';
                }

                div.className = className;
                div.innerHTML = `
                    <span style="font-weight:600;">${formatTime(slot.start)} - ${formatTime(slot.end)}</span>
                    <span style="font-size: 0.9em; opacity: 0.8;">${typeText}</span>
                `;
                slotsContainer.appendChild(div);
            });
        }

        function updateCountdown(todaySlots, tomorrowSlots, currentHour) {
            timerContainer.classList.remove('hidden');
            const currentSlot = todaySlots.find(s => currentHour >= s.start && currentHour < s.end);
            
            if (!currentSlot) {
                timerValue.textContent = "--:--";
                return;
            }

            const type = currentSlot.type;
            
            const findNext = (conditionFn) => {
                let next = todaySlots.find(s => s.start > currentHour && conditionFn(s));
                if (next) return next.start - currentHour;
                if (tomorrowSlots && tomorrowSlots.length > 0) {
                    next = tomorrowSlots.find(s => conditionFn(s));
                    if (next) return (24 - currentHour) + next.start;
                }
                return null;
            };

            // 1. –°–≤–µ—Ç –ï–°–¢–¨ -> –ò—â–µ–º –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ. –¢–∞–π–º–µ—Ä –ó–ï–õ–ï–ù–´–ô (–≤—Å–µ —Ö–æ—Ä–æ—à–æ)
            if (type === 'ELECTRICITY') {
                const diff = findNext(s => s.type !== 'ELECTRICITY');
                
                timerLabel.textContent = "–°–≤–µ—Ç –≤—ã–∫–ª—é—á–∞—Ç —á–µ—Ä–µ–∑";
                if (diff !== null) {
                    timerValue.textContent = formatDuration(diff);
                } else {
                    timerValue.textContent = "–ü–æ –≥—Ä–∞—Ñ–∏–∫—É –Ω–µ—Ç";
                }
                timerValue.className = "timer-value timer-green";
            }
            // 2. –û—Ç–∫–ª—é—á–µ–Ω–∏–µ -> –ò—â–µ–º —Å–≤–µ—Ç. –¢–∞–π–º–µ—Ä –ö–†–ê–°–ù–´–ô (–≤–Ω–∏–º–∞–Ω–∏–µ)
            else {
                const diff = findNext(s => s.type === 'ELECTRICITY');
                
                timerLabel.textContent = "–°–≤–µ—Ç –≤–∫–ª—é—á–∞—Ç —á–µ—Ä–µ–∑"; 
                
                if (diff !== null) {
                    timerValue.textContent = formatDuration(diff);
                } else {
                    const endDiff = currentSlot.end - currentHour;
                    timerValue.textContent = formatDuration(endDiff); 
                }
                timerValue.className = "timer-value timer-red";
            }
        }

        function formatDuration(hoursVal) {
            if (hoursVal === null || hoursVal < 0 || isNaN(hoursVal)) return "--:--";
            const totalMinutes = Math.round(hoursVal * 60);
            const h = Math.floor(totalMinutes / 60);
            const m = totalMinutes % 60;
            return `${h}—á ${m.toString().padStart(2, '0')}–º`;
        }

        function updateStatusHeader(slots, currentHour) {
            const title = document.getElementById('statusTitle');
            const sub = document.getElementById('statusSub');
            if (!slots) {
                title.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
                title.className = 'status unknown';
                sub.textContent = '-';
                return;
            }
            const currentSlot = slots.find(s => currentHour >= s.start && currentHour < s.end);
            
            if (!currentSlot) {
                title.textContent = '–°–≤–µ—Ç –µ—Å—Ç—å';
                title.className = 'status on';
                sub.textContent = '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ—Ç–∫–ª—é—á–µ–Ω–∏–π';
                return;
            }

            if (currentSlot.type === 'DEFINITE_OUTAGE') {
                title.textContent = '–°–≤–µ—Ç–∞ –Ω–µ—Ç';
                title.className = 'status off';
                sub.textContent = '–î–µ–π—Å—Ç–≤—É–µ—Ç —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ';
            } else if (currentSlot.type === 'POSSIBLE_OUTAGE') {
                title.textContent = '–í–æ–∑–º–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ';
                title.className = 'status unknown'; 
                title.style.color = 'var(--muted)';
                sub.textContent = '–°–µ—Ä–∞—è –∑–æ–Ω–∞';
            } else {
                title.textContent = '–°–≤–µ—Ç –µ—Å—Ç—å';
                title.className = 'status on';
                title.style.color = '';
                sub.textContent = '–ü–æ –≥—Ä–∞—Ñ–∏–∫—É —Å–≤–µ—Ç –µ—Å—Ç—å';
            }
        }

        function formatTime(val) {
            const h = Math.floor(val);
            const m = (val - h) * 60;
            const hStr = h.toString().padStart(2, '0');
            const mStr = Math.round(m).toString().padStart(2, '0');
            return `${hStr}:${mStr}`;
        }

        init();
    </script>
</body>
</html>
